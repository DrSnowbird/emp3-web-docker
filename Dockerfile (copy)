FROM openkbs/jdk-mvn-py3

MAINTAINER DrSnowbird "DrSnowbird@openkbs.org"

#### ------------------------
#### ---- user: Non-Root ----
#### ------------------------

ARG USER_ID=${USER_ID:-1000}
ENV USER_ID=${USER_ID}

ARG GROUP_ID=${GROUP_ID:-1000}
ENV GROUP_ID=${GROUP_ID}

ENV USER=${USER:-developer}
ENV USER_NAME=${USER}

ENV HOME=/home/${USER}

RUN groupadd -f --gid ${GROUP_ID} ${USER} && \
    #useradd ${USER} -m -d ${HOME} -s /bin/bash -u ${USER_ID} -g ${GROUP_ID} && \
    useradd ${USER} -m -d ${HOME} -s /bin/bash -u ${USER_ID} -g ${USER} && \
    ## -- Ubuntu -- \
    usermod -aG sudo ${USER} && \
    ## -- Centos -- \
    #usermod -aG wheel ${USER} && \
    echo "${USER} ALL=NOPASSWD:ALL" | tee -a /etc/sudoers && \
    export uid=${USER_ID} gid=${GROUP_ID} && \
    chown ${USER}:${USER} -R ${HOME}

####################################
#### ---- Grunt setup      ---- ####
####################################

#### --- Copy Entrypoint script in the container ---- ####
COPY ./docker-entrypoint.sh /

RUN npm install -g grunt-cli  

####################################
#### ---- EMP3 Install     ---- ####
####################################
USER ${USER}
WORKDIR ${HOME}

RUN mkdir -p ${HOME}/workspace 

RUN sudo chown ${USER}:${USER} ${HOME} ${HOME}/.config ${HOME}/.npm && \
    git clone https://github.com/missioncommand/emp3-web.git && \
    cd ${HOME}/emp3-web && npm install && \
    grunt --force

####################################
#### ---- Enterpoint setup ---- ####
####################################
USER ${USER}

WORKDIR ${HOME}/emp3-web

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["/usr/bin/grunt --force serve"]

#### (Test only)
#CMD ["/usr/bin/firefox"]
#CMD ["/bin/bash"]

